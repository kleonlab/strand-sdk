<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GeneLoop Demo (Interactive Fake CLI)</title>
  <style>
    /* Theme tokens (mapped to your design system) */
    :root {
      /* default set is dark; overwritten by [data-theme] below */
      --background: oklch(0.19 0.02 260);
      --foreground: oklch(0.96 0.02 260);
      --card: oklch(0.22 0.02 260);
      --card-foreground: var(--foreground);
      --primary: oklch(0.5855 0.1006 208.0245);
      --primary-foreground: oklch(1 0 0);
      --secondary: oklch(0.48 0.0825 206.0615);
      --secondary-foreground: oklch(1 0 0);
      --muted: oklch(0.28 0.01 260);
      --muted-foreground: oklch(0.70 0.02 260);
      --accent: oklch(0.6697 0.1154 208.9445);
      --accent-foreground: oklch(1 0 0);
      --destructive: oklch(0.5771 0.2152 27.3250);
      --destructive-foreground: oklch(1 0 0);
      --border: oklch(0.30 0.01 260);
      --input: var(--border);
      --ring: var(--primary);
      --font-mono: "Fira Code", SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    :root[data-theme="light"] {
      --background: oklch(0.9970 0 0);
      --foreground: oklch(0.2047 0.0220 205.9882);
      --card: oklch(0.9940 0 0);
      --card-foreground: oklch(0.2047 0.0220 205.9882);
      --primary: oklch(0.5855 0.1006 208.0245);
      --primary-foreground: oklch(1 0 0);
      --secondary: oklch(0.4820 0.0825 206.0615);
      --secondary-foreground: oklch(1 0 0);
      --muted: oklch(0.9712 0.0076 207.1422);
      --muted-foreground: oklch(0.4758 0.0287 212.4485);
      --accent: oklch(0.6697 0.1154 208.9445);
      --accent-foreground: oklch(1 0 0);
      --destructive: oklch(0.5771 0.2152 27.3250);
      --destructive-foreground: oklch(1 0 0);
      --border: oklch(0.9351 0.0118 203.4677);
      --input: var(--border);
      --ring: oklch(0.5855 0.1006 208.0245);
    }
    :root[data-theme="dark"] {
      --background: oklch(0.19 0.02 260);
      --foreground: oklch(0.96 0.02 260);
      --card: oklch(0.22 0.02 260);
      --card-foreground: var(--foreground);
      --primary: oklch(0.5855 0.1006 208.0245);
      --primary-foreground: oklch(1 0 0);
      --secondary: oklch(0.48 0.0825 206.0615);
      --secondary-foreground: oklch(1 0 0);
      --muted: oklch(0.28 0.01 260);
      --muted-foreground: oklch(0.70 0.02 260);
      --accent: oklch(0.6697 0.1154 208.9445);
      --accent-foreground: oklch(1 0 0);
      --destructive: oklch(0.5771 0.2152 27.3250);
      --destructive-foreground: oklch(1 0 0);
      --border: oklch(0.30 0.01 260);
      --input: var(--border);
      --ring: var(--primary);
    }

    /* Map design tokens to CLI theme */
    :root { --bg: var(--background); --fg: var(--foreground); --muted-txt: var(--muted-foreground); --blue: var(--primary); --green: oklch(0.78 0.12 150); --yellow: oklch(0.88 0.12 92); --red: var(--destructive); }

    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 var(--font-mono);}    
    .frame{max-width:1100px;margin:24px auto;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px color-mix(in oklch, black 35%, transparent);border:1px solid var(--border)}
    .titlebar{background:var(--card);height:36px;display:flex;align-items:center;gap:8px;padding:0 12px;border-bottom:1px solid var(--border)}
    .dot{width:12px;height:12px;border-radius:50%}
    .dot.red{background:#ff5f57}.dot.yellow{background:#febc2e}.dot.green{background:#28c840}
    .tabs{margin-left:12px;color:var(--muted-foreground);font-size:13px;opacity:.85}
    .spacer{flex:1}
    .toggle{background:transparent;border:1px solid var(--border);color:var(--fg);border-radius:8px;padding:3px 8px;font-size:12px;cursor:pointer}
    .toggle:hover{background:color-mix(in oklch, var(--primary) 10%, transparent);}
    .term{padding:16px 18px 80px;height:65vh;position:relative;overflow:auto}
    .line{white-space:pre-wrap;word-break:break-word}
    .muted{color:var(--muted-txt)}
    .ok{color:var(--green)}.warn{color:var(--yellow)}.err{color:var(--red)}.info{color:var(--blue)}
    .prompt{position:sticky;bottom:0;left:0;right:0;background:linear-gradient(180deg, color-mix(in oklch, var(--bg) 0%, transparent) 0%, var(--bg) 30%);padding-top:24px}
    .row{display:flex;gap:8px;align-items:center}
    .label{color:var(--primary)}
    .path{color:var(--secondary)}
    .cursor{display:inline-block;width:8px;background:#cfcfcf;margin-left:2px;animation:blink 1s step-start infinite}
    @keyframes blink{50%{opacity:0}}
    .input{outline:none;border:none;background:transparent;color:var(--fg);flex:1;min-width:10px}
    .kbd{color:var(--muted-foreground);background:var(--card);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:12px}
    /* removed floating help overlay */
    code{color:#d1d1d1}
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
  <div class="frame">
    <div class="titlebar">
      <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
      <div class="tabs">iTerm — GeneLoop Demo</div>
      <div class="spacer"></div>
      <button id="themeToggle" class="toggle" aria-label="Toggle theme">Toggle Theme</button>
    </div>
    <div class="term" id="term" aria-live="polite">
      <!-- (intentionally no floating examples to keep it realistic) -->
      <!-- Output lines go here -->
      <div id="log"></div>

      <!-- Prompt -->
      <div class="prompt">
        <div class="row">
          <span class="label" id="promptLabel">macbook</span>:<span class="path">~/geneloop-demo</span> $
          <span id="input" class="input" contenteditable="true" spellcheck="false" aria-label="Terminal input"></span>
          <span class="cursor" id="cursor"> </span>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const log = document.getElementById('log');
    const input = document.getElementById('input');
    const term = document.getElementById('term');
    const promptLabel = document.getElementById('promptLabel');
    const themeToggle = document.getElementById('themeToggle');
    let busy=false, waitingPrompt=null; // {label, accept: fn}
    const DELAY = 1.6; // slow things down a bit for realism

    const scroll = () => term.scrollTop = term.scrollHeight;
    const add = (txt, cls='line') => { const d=document.createElement('div'); d.className=cls; d.textContent=txt; log.appendChild(d); scroll(); };
    const addHTML = (html) => { const d=document.createElement('div'); d.className='line'; d.innerHTML=html; log.appendChild(d); scroll(); };
    const echo = (cmd) => add(`macbook:~/geneloop-demo $ ${cmd}`);
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

    // Theme init
    (function initTheme(){
      const saved = localStorage.getItem('gl-theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
      themeToggle.textContent = theme === 'dark' ? 'Light' : 'Dark';
    })();
    themeToggle.addEventListener('click', ()=>{
      const current = document.documentElement.getAttribute('data-theme') || 'light';
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('gl-theme', next);
      themeToggle.textContent = next === 'dark' ? 'Light' : 'Dark';
    });

    // Simple spinner line
    function spinner(text, duration=1400, doneText){
      return new Promise(resolve=>{
        const row=document.createElement('div');
        row.className='line';
        const frames=['⠋','⠙','⠹','⠸','⠼','⠴','⠦','⠧','⠇','⠏'];
        let i=0;
        const tick=()=>{ row.textContent=`${text} ${frames[i++%frames.length]}`; };
        tick();
        log.appendChild(row); scroll();
        const iv=setInterval(tick,80);
        setTimeout(()=>{ clearInterval(iv); row.textContent= doneText || `${text} done`; scroll(); resolve(); }, duration*DELAY);
      });
    }

    // Simple scripted runner
    async function runSteps(steps){
      busy=true;
      for(const s of steps){
        if(s.type==='print'){ add(s.text); if(s.delay) await sleep(s.delay); }
        else if(s.type==='printHTML'){ addHTML(s.html); if(s.delay) await sleep(s.delay); }
        else if(s.type==='spin'){ await spinner(s.text, s.duration, s.doneText); }
        else if(s.type==='prompt'){
          waitingPrompt={ label: s.label, accept: s.accept };
          promptLabel.textContent=s.label; // show question in prompt label
          const ans = await waitForAnswer();
          add(`${s.label}: ${ans}`);
          promptLabel.textContent='macbook';
          waitingPrompt=null;
          if(s.onAnswer) await s.onAnswer(ans);
        }
      }
      busy=false;
    }

    function waitForAnswer(){ return new Promise(resolve=>{ waitingPrompt.resolve=resolve; }); }

    // COMMAND SCRIPTS
    function scriptDebug(arg){
      const bam = arg || 'sample.bam';
      return [
        {type:'spin', text:'[GeneLoop] Scanning filesystem (cwd, neighbors)…', duration:1200, doneText:'[GeneLoop] Scanning filesystem… ok'},
        {type:'spin', text:`[GeneLoop] Opening ${bam} (headers, flags)…`, duration:1200, doneText:'[GeneLoop] Detecting file type…      ok (BAM)'},
        {type:'print', text:'[GeneLoop] Quick sanity checks…      ok (sorted: coordinate)', delay:500*DELAY},
        {type:'print', text:'[GeneLoop] Index presence…           missing (.bai not found)', delay:700*DELAY},
        {type:'print', text:'[GeneLoop] Read summary (fast scan):', delay:50},
        {type:'print', text:'  - total reads: ~42,317,894'},
        {type:'print', text:'  - mapped: 97.6%   | properly paired: 95.8%'},
        {type:'print', text:'  - duplicates: 11.9% (flag-based)'},
        {type:'print', text:'  - multimappers: 6.3%'},
        {type:'print', text:'  - median insert size: 286 bp'},
        {type:'print', text:'  - GC content (reads): 42% | reference: 41%', delay:400*DELAY},
        {type:'spin', text:'[Model] Thinking…', duration:1200, doneText:'[Model] Reasoning complete'},
        {type:'print', text:'[Model] Hypothesis: BAM is sorted; missing sidecar index (.bai).', delay:450*DELAY},
        {type:'print', text:'[Model] Evidence: SO:coordinate in header; .bai absent; typical idxstats/IGV failure.', delay:300*DELAY},
        {type:'print', text:'[Model] Plan: propose samtools index; re-check; warn on multimappers/GC.', delay:300*DELAY},
        {type:'print', text:'[Issue 1] Missing BAM index'},
        {type:'print', text:`  Fix: samtools index -@ 8 ${bam}`, delay:200},
        {type:'print', text:'[Issue 2] Multimapper noise (6.3%) — consider MAPQ >=10 or STAR', delay:300},
        {type:'print', text:'[Note] GC bias (coarse) — no strong deviation observed', delay:300},
        {type:'print', text:'[GeneLoop] Suggested next command:'},
        {type:'print', text:`  samtools index -@ 8 ${bam} && samtools idxstats ${bam} | head`, delay:300},
        {type:'prompt', label:'[Decision] Auto-generate fix command? [y/N]', accept:(v)=>/^y(es)?$/i.test(v), onAnswer: async (ans)=>{
          if(!/^y(es)?$/i.test(ans)){ add('Aborted.'); return; }
          add(`Running: samtools index -@ 8 ${bam}`); await spinner('  writing index…', 1500, '  writing index… done');
          add('[Index] Done: sample.bam.bai (2.1s)'); await sleep(350*DELAY);
          add('Re-checking…'); await spinner('[GeneLoop] Loading index…', 900, '[GeneLoop] Loading index… ok');
          add('[GeneLoop] Index presence…           ok'); await sleep(300*DELAY);
          add('[GeneLoop] Ready for IGV / variant calling.'); await sleep(200);
          add('Summary');
          add(`  Root cause: Missing .bai after sort`);
          add(`  Fix applied: samtools index -@ 8 ${bam}`);
          add('  Risk notes: multimappers ~6.3%; consider MAPQ filter (>=10)');
        }}
      ];
    }

    function scriptGen(){
      return [
        {type:'spin', text:'[GeneLoop] Parsing intent…', duration:900, doneText:'[GeneLoop] Parsing intent… ok'},
        {type:'print', text:'[Model] Reasoning: paired-end RNA‑seq; hg38; prefer bwa-mem2 for demo speed.', delay:450*DELAY},
        {type:'print', text:'[Model] Plan: emit minimal idempotent slice + environment pins.', delay:350*DELAY},
        {type:'spin', text:'[GeneLoop] Resolving toolchain (bwa-mem2, samtools)…', duration:1100, doneText:'[GeneLoop] Toolchain… ok'},
        {type:'print', text:'[GeneLoop] Emitting idempotent Snakemake slice (FASTQ ➜ BAM)', delay:350*DELAY},
        {type:'printHTML', html:
`# Snakefile\nrule all:\n    input: expand("results/bam/{sample}.bam.bai", sample=lambda: config['samples'])\n\nrule align_and_sort:\n    input:\n        r1="data/fastq/{sample}_R1.fastq.gz",\n        r2="data/fastq/{sample}_R2.fastq.gz",\n        ref="refs/hg38.fa"\n    output:\n        bam=temp("results/bam/{sample}.bam"),\n        bai="results/bam/{sample}.bam.bai"\n    params:\n        threads=8,\n        bwa_opts="-R '@RG\\tID:{wildcards.sample}\\tSM:{wildcards.sample}\\tPL:ILLUMINA'"\n    log: "logs/{sample}.align.log"\n    conda: "envs/aln.yaml"\n    shell:\n        r"""\n        set -eo pipefail\n        if [ ! -s {output.bam} ]; then\n          bwa-mem2 mem -t {params.threads} {params.bwa_opts} {input.ref} {input.r1} {input.r2} 2>> {log} \\| samtools view -@ {params.threads} -bS - \\| samtools sort -@ {params.threads} -o {output.bam} - 2>> {log}\n        fi\n        samtools index -@ {params.threads} {output.bam} 2>> {log}\n        """`, delay:200},
        {type:'printHTML', html:
`# envs/aln.yaml\nname: biocode-aln\nchannels: [conda-forge, bioconda]\ndependencies:\n  - bwa-mem2=2.*\n  - samtools=1.19.*`, delay:150},
        {type:'printHTML', html:
`# config.yaml\nsamples:\n  - sampleA\n  - sampleB`, delay:150},
        {type:'print', text:'[GeneLoop] Files written: Snakefile, envs/aln.yaml, config.yaml (virtual).', delay:200*DELAY},
        {type:'print', text:'Notes: Replace BWA-MEM2 with STAR for spliced RNA‑seq if preferred.', delay:80},
        {type:'print', text:'Idempotent: no re-run if outputs exist; index enforced.'}
      ];
    }

    function scriptExplain(){
      return [
        {type:'spin', text:'[GeneLoop] Reading file: legacy/fasta_parser.pl…', duration:900, doneText:'[GeneLoop] File read'},
        {type:'print', text:'[Explain] Summary', delay:250*DELAY},
        {type:'print', text:'  - Purpose: parse FASTA records and print id\tlength TSV.'},
        {type:'print', text:'  - Flow: detect headers (">id"), accumulate sequence lines per id, output lengths.'},
        {type:'print', text:'[Explain] Assumptions'},
        {type:'print', text:'  - Header regex: /^(\\S+)/ captures ID without spaces.'},
        {type:'print', text:'  - Multiline sequences supported; blank lines ignored.'},
        {type:'print', text:'[Explain] Pitfalls'},
        {type:'print', text:'  - Memory growth: stores entire sequences in a hash (large FASTA → high RAM).'},
        {type:'print', text:'  - Malformed/missing headers collapse into empty key; no warnings.'},
        {type:'print', text:'[Explain] Edge cases'},
        {type:'print', text:'  - Headers with spaces truncated at first whitespace.'},
        {type:'print', text:'  - Non-FASTA lines are concatenated silently.'},
        {type:'print', text:'[Explain] Next steps'},
        {type:'print', text:'  - Add input validation + friendly errors.'},
        {type:'print', text:'  - Add tests: empty file, multiline, odd headers. Consider streaming parser.'}
      ];
    }

    function scriptRefactor(){
      return [
        {type:'spin', text:'[GeneLoop] Loading file: legacy/fasta_parser.pl…', duration:900, doneText:'[GeneLoop] File loaded'},
        {type:'print', text:'[Model] Goal: refactor to Python (Biopython) with same behavior.', delay:300*DELAY},
        {type:'print', text:'[Model] Plan: typed function + CLI main; stream records via SeqIO.', delay:280*DELAY},
        {type:'printHTML', html:
`Original (Perl, excerpt):\n------------------------------------------------------------\nopen(my $fh, "<", $ARGV[0]) or die $!;\nmy %seq; my $h = "";\nwhile (my $l = <$fh>) {\n  chomp $l;\n  if ($l =~ /^>(\\S+)/) { $h = $1; $seq{$h} = ""; }\n  else { $seq{$h} .= $l; }\n}\nfor my $k (keys %seq) { print "$k\\t" . length($seq{$k}) . "\\n"; }`, delay:220},
        {type:'printHTML', html:
`Refactor (Python 3, Biopython):\n------------------------------------------------------------\nfrom __future__ import annotations\nfrom typing import Dict\nfrom Bio import SeqIO\nfrom pathlib import Path\nimport sys\n\ndef fasta_lengths(path: str | Path) -> Dict[str, int]:\n    records = SeqIO.parse(str(path), "fasta")\n    return {rec.id: len(rec.seq) for rec in records}\n\nif __name__ == "__main__":\n    if len(sys.argv) < 2:\n        sys.exit("usage: python fasta_lengths.py <file.fasta>")\n    lengths = fasta_lengths(sys.argv[1])\n    for k, v in lengths.items():\n        print(f"{k}\\t{v}")`, delay:180},
        {type:'print', text:'Why safer: Biopython parser; typed; stream-based; easy tests.', delay:140},
        {type:'print', text:'Next: add friendly error messages; optional TSV output.'}
      ];
    }

    // Input handling
    function sanitize(s){ return s.replace(/\n/g,' ').trim(); }
    async function handle(cmd){
      const c = sanitize(cmd);
      if(!c) return;
      echo(c);
      input.textContent='';
      if(busy){ add('Busy… press Enter after current action.'); return; }
      // Commands
      if(c==='clear'){ log.innerHTML=''; return; }
      // geneloop help variants
      if(/^geneloop\s+(-h|--help|-help|help)?$/i.test(c)){
        add('GeneLoop CLI v0.0.0 (demo)');
        add('Usage: geneloop <command> [options]');
        add('');
        add('Commands:');
        add('  debug <bam>              Diagnose common BAM issues; suggest fixes.');
        add('  gen "<goal>"             Generate idempotent Snakemake slice.');
        add('  explain <file>           Summarize behavior, assumptions, pitfalls.');
        add('  refactor <file> [--target=python] [--library=biopython]');
        add('');
        add('Flags:');
        add('  -h, --help               Show this help.');
        add('');
        add('Examples:');
        add('  geneloop debug sample.bam');
        add('  geneloop gen "FASTQ to BAM: paired-end RNA-seq; hg38"');
        add('  geneloop explain legacy/fasta_parser.pl');
        add('  geneloop refactor legacy/fasta_parser.pl --target=python --library=biopython');
        return;
      }
      if(/^geneloop\s+debug/i.test(c)){
        const m = c.match(/^geneloop\s+debug\s+(\S+)/i); const bam = m?m[1]:undefined;
        await runSteps(scriptDebug(bam)); return;
      }
      if(/^geneloop\s+gen/i.test(c)){ await runSteps(scriptGen()); return; }
      if(/^geneloop\s+explain/i.test(c)){ await runSteps(scriptExplain()); return; }
      if(/^geneloop\s+refactor/i.test(c)){ await runSteps(scriptRefactor()); return; }
      if(/^(help)$/i.test(c)) { add('Try: geneloop -help'); return; }
      // Natural language intent parser
      const intent = inferIntent(c);
      if(intent){
        add(`[GeneLoop] Parsed intent → ${intent.canonical}`);
        if(intent.kind==='debug') { await runSteps(scriptDebug(intent.arg)); return; }
        if(intent.kind==='gen') { await runSteps(scriptGen()); return; }
        if(intent.kind==='explain') { await runSteps(scriptExplain()); return; }
        if(intent.kind==='refactor') { await runSteps(scriptRefactor()); return; }
      }
      add('Command not found. Try "geneloop -help".');
    }

    // Heuristic intent inference for natural phrases
    function inferIntent(text){
      const t = text.toLowerCase();
      const fileMatch = text.match(/(\S+\.(?:bam|fastq(?:\.gz)?|fq(?:\.gz)?|fasta|fa|pl|py))/i);
      const file = fileMatch ? fileMatch[1] : undefined;
      const has = (...words)=> words.some(w=> t.includes(w));

      // Debug if mentions debug/fix/bam/index and we have a .bam
      if((has('debug','fix','issue','problem','index','idx','bam') && /\.bam\b/i.test(file||'')) || (has('how can i debug') && file)){
        return {kind:'debug', arg:file||'sample.bam', canonical:`geneloop debug ${file||'sample.bam'}`};
      }
      // Generate pipeline intents
      if(has('generate','make','create','pipeline','snakemake','rna-seq','rna seq','fastq to bam','starter') || /fastq\b/i.test(t)){
        return {kind:'gen', canonical:'geneloop gen "FASTQ to BAM: paired-end RNA-seq; hg38"'};
      }
      // Explain legacy code intents
      if(has('explain','what does','summarize','understand','walk me through') && file){
        return {kind:'explain', arg:file, canonical:`geneloop explain ${file}`};
      }
      // Refactor intents
      if((has('refactor','rewrite','convert','port','modernize') && file) || has('turn this into python')){
        return {kind:'refactor', arg:file, canonical:`geneloop refactor ${file} --target=python --library=biopython`};
      }
      return null;
    }

    // Key handling (contenteditable)
    input.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        e.preventDefault();
        const val = input.textContent.trim();
        if(waitingPrompt){
          const ans = val || 'n';
          input.textContent='';
          waitingPrompt.resolve(ans);
          return;
        }
        handle(val);
      }
    });
    // Click to focus
    document.addEventListener('click', ()=> input.focus());
    // Initial hint
    add('GeneLoop CLI (demo) — type "geneloop -help" for commands.');
    input.focus();
  })();
  </script>
</body>
</html>
